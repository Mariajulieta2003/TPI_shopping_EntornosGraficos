<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Dashboard Cliente • Promociones</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">

  <style>
    :root{
      --primary: #4A3BC7;
      --primary-rgb: 74,59,199;
      --subtle: #F3F1FF;

      --muted: #6c6c6c;
      --light-card: #ffffff;
      --card-border: rgba(74,59,199,0.06);
      --success: #28a745;
    }

    /* Global */
    html,body { height:100%; }
    body {
      background: linear-gradient(180deg, #fff 0%, var(--subtle) 100%);
      color: #222;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }

    /* Navbar */
    .navbar { background: var(--primary); color: #fff; }
    .navbar .navbar-brand { font-weight:700; color:#fff; }
    .btn-primary { background: var(--primary); border-color: rgba(var(--primary-rgb),0.9); }
    .btn-primary:focus, .btn-primary:hover { filter: brightness(0.95); }

    /* Layout */
    .sidebar { min-height: 100vh; background: #fff; border-right: 1px solid #e9e9ef; padding:1.25rem 1rem; }
    .sidebar .nav-link { color: #333; border-radius:.5rem; }
    .sidebar .nav-link.active { background: rgba(var(--primary-rgb),0.08); color: var(--primary); font-weight:600; }

    main { padding: 1.5rem; }

    /* Cards & promos */
    .card { border-radius: .7rem; }
    .promo-card { border-radius:.75rem; border:1px solid var(--card-border); background: var(--light-card); transition: transform .12s ease, box-shadow .12s ease; display:flex; flex-direction:column; height:100%; padding:1rem; }
    .promo-card:hover { transform: translateY(-4px); box-shadow: 0 10px 30px rgba(74,59,199,0.06); }
    .promo-badge { background: rgba(var(--primary-rgb),0.10); color: var(--primary); font-weight:600; padding:.25rem .5rem; border-radius:.5rem; font-size:.85rem; }

    .urgent { background: linear-gradient(90deg,var(--primary), rgba(var(--primary-rgb),0.85)); color:#fff; padding:.2rem .5rem; border-radius:.5rem; font-size:.85rem; }

    .small-muted { color: var(--muted); font-size:.92rem; }

    /* Accessibility focus */
    a:focus, button:focus, input:focus, select:focus { outline: 3px solid rgba(var(--primary-rgb),0.12); outline-offset: 2px; }

    /* Responsive helper */
    @media (max-width:767px){
      .sidebar { min-height: auto; border-right: none; border-bottom:1px solid #eee; }
    }

    /* Skeleton */
    .skeleton {
      display:block;
      background: linear-gradient(90deg,#eee,#f5f5f5,#eee);
      border-radius:.5rem;
      animation: pulse 1.2s infinite;
    }
    @keyframes pulse { 0%{opacity:1}50%{opacity:.6}100%{opacity:1} }
  </style>
</head>
<body>

  <!-- NAVBAR -->
  <nav class="navbar navbar-expand-lg sticky-top">
    <div class="container-fluid">
      <a class="navbar-brand" href="#">ShoppingOfertas</a>

      <div class="d-flex align-items-center ms-auto">
        <form class="d-none d-md-flex me-3" role="search" action="/buscar" method="get" aria-label="Buscar promociones">
          <input name="q" class="form-control form-control-sm" type="search" placeholder="Buscar promociones..." aria-label="Buscar">
        </form>

        <!-- User dropdown placeholder -->
        <div class="dropdown">
          <a class="d-flex align-items-center text-white text-decoration-none dropdown-toggle" href="#" id="userDropdown" data-bs-toggle="dropdown" aria-expanded="false">
            <img src="https://via.placeholder.com/36/ffffff/000000?text=U" alt="avatar" width="36" height="36" class="rounded-circle me-2">
            <strong class="me-2">Usuario</strong>
          </a>
          <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
            <li><a class="dropdown-item" href="/perfil.php">Mi perfil</a></li>
            <li><a class="dropdown-item" href="/mis_promociones.php">Mis promociones</a></li>
            <li><hr class="dropdown-divider"></li>
            <li><a class="dropdown-item text-danger" href="/logout.php">Cerrar sesión</a></li>
          </ul>
        </div>
      </div>
    </div>
  </nav>

  <div class="container-fluid">
    <div class="row">

      <!-- SIDEBAR -->
      <aside class="col-12 col-md-3 col-lg-2 sidebar">
        <h6 class="mb-3 text-muted">Navegación</h6>
        <ul class="nav flex-column mb-3" role="navigation" aria-label="Menú principal">
          <li class="nav-item mb-1"><a class="nav-link active" href="#inicio"><i class="bi bi-house-door-fill me-2"></i>Inicio</a></li>
          <li class="nav-item mb-1"><a class="nav-link" href="#promociones-publicas"><i class="bi bi-tags me-2"></i>Promociones</a></li>
          <li class="nav-item mb-1"><a class="nav-link" href="/buscar_local.php"><i class="bi bi-geo-alt me-2"></i>Buscar local</a></li>
          <li class="nav-item mb-1"><a class="nav-link" href="/historial.php"><i class="bi bi-clock-history me-2"></i>Historial</a></li>
          <li class="nav-item mb-1"><a class="nav-link" href="/novedades.php"><i class="bi bi-bell me-2"></i>Novedades</a></li>
        </ul>

        <hr>

        <div class="small-muted mb-2">Tu categoría</div>
        <div class="d-flex align-items-center mb-2">
          <span class="promo-badge">Inicial</span>
          <span class="ms-auto small-muted">Progreso: 2/5</span>
        </div>
        <div class="progress mb-3" style="height:8px;">
          <div class="progress-bar" role="progressbar" style="width:40%; background: linear-gradient(90deg,var(--primary), rgba(var(--primary-rgb), 0.85));" aria-valuenow="40" aria-valuemin="0" aria-valuemax="100"></div>
        </div>

        <div class="small-muted">Atajos</div>
        <ul class="list-unstyled mt-2">
          <li><a class="text-decoration-none" href="/mis_promociones.php"><i class="bi bi-ticket-perforated me-2"></i>Mis cupones</a></li>
          <li><a class="text-decoration-none" href="/perfil.php"><i class="bi bi-person me-2"></i>Editar perfil</a></li>
        </ul>
      </aside>

      <!-- MAIN -->
      <main class="col-12 col-md-9 col-lg-10" id="main" tabindex="-1">
        <div id="inicio" class="pb-4">

          <!-- HEADER DASHBOARD -->
          <div class="d-flex justify-content-between align-items-start mb-3">
            <div>
              <h1 class="h4 mb-1">Descubrí las mejores tiendas y ofertas</h1>
              <p class="small-muted mb-0">Bienvenido — aquí verás las promociones más relevantes para ti.</p>
            </div>

            <div class="d-flex gap-2">
              <a class="btn btn-outline-secondary btn-sm" href="/novedades.php">Novedades</a>
              <a class="btn btn-primary btn-sm" href="/mis_promociones.php">Mis promociones</a>
            </div>
          </div>

          <!-- DASHBOARD CARDS -->
          <div class="row g-3 mb-4">
            <div class="col-12 col-md-4">
              <div class="card shadow-sm">
                <div class="card-body">
                  <div class="d-flex justify-content-between align-items-start">
                    <div>
                      <h6 class="mb-1">Promociones disponibles</h6>
                      <div class="h3 mb-0" id="count-available">--</div>
                      <div class="small-muted">Vigentes para tu categoría</div>
                    </div>
                    <div>
                      <i class="bi bi-ticket-perforated" style="font-size:28px; color:var(--primary)"></i>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="col-12 col-md-4">
              <div class="card shadow-sm">
                <div class="card-body">
                  <h6 class="mb-1">Promociones usadas</h6>
                  <div class="h3 mb-0" id="count-used">--</div>
                  <div class="small-muted">Últimos 6 meses</div>
                </div>
              </div>
            </div>

            <div class="col-12 col-md-4">
              <div class="card shadow-sm">
                <div class="card-body">
                  <h6 class="mb-1">Novedades activas</h6>
                  <div class="h3 mb-0" id="count-news">--</div>
                  <div class="small-muted">Para tu categoría</div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- PROMOCIONES PÚBLICAS (visible para todos) -->
        <section id="promociones-publicas" aria-labelledby="promos-heading" class="mb-5">
          <style>
            /* Scoped helpers to ensure styling consistency inside the section */
            #promos-grid .promo-img { width:96px; height:96px; object-fit:cover; border-radius:.5rem; }
            .card-header-primary { background: var(--primary); color:#fff; border-radius:.5rem .5rem 0 0; padding:.75rem 1rem; margin-bottom:1rem; }
          </style>

          <div class="card">
            <div class="card-header card-header-primary d-flex justify-content-between align-items-center">
              <div>
                <h2 id="promos-heading" class="h6 mb-0">Promociones para todos</h2>
                <div class="small-muted">Ofertas públicas y vigentes. Aplica filtros para afinar.</div>
              </div>

              <div class="d-flex gap-2 align-items-center" role="toolbar" aria-label="Controles de promociones">
                <input id="promos-search" class="form-control form-control-sm" type="search" placeholder="Buscar por local, rubro o descuento" aria-label="Buscar promociones">
                <select id="promos-filter-rubro" class="form-select form-select-sm" aria-label="Filtrar por rubro">
                  <option value="">Todos los rubros</option>
                </select>
                <button id="promos-clear" class="btn btn-outline-light btn-sm" title="Limpiar filtros">Limpiar</button>
              </div>
            </div>

            <div class="card-body">
              <!-- filtros secundarios y contadores -->
              <div class="row align-items-center mb-3">
                <div class="col-12 col-md-6">
                  <div class="d-flex gap-2 flex-wrap" role="tablist" aria-label="Ordenar promociones">
                    <button class="btn btn-sm btn-outline-secondary active" data-sort="relevancia">Más relevantes</button>
                    <button class="btn btn-sm btn-outline-secondary" data-sort="vigencia">Vigencia</button>
                    <button class="btn btn-sm btn-outline-secondary" data-sort="descuento">Mayor descuento</button>
                  </div>
                </div>

                <div class="col-12 col-md-6 text-md-end small text-muted">
                  <span id="promos-count">Cargando promociones...</span>
                </div>
              </div>

              <!-- Grid -->
              <div id="promos-grid" class="row row-cols-1 row-cols-sm-2 row-cols-lg-3 g-3" aria-live="polite">
                <!-- Cards se renderizan por JS -->
                <!-- Skeleton inicial (3) -->
                <div class="col"><div class="skeleton" style="height:160px"></div></div>
                <div class="col d-none d-sm-block"><div class="skeleton" style="height:160px"></div></div>
                <div class="col d-none d-lg-block"><div class="skeleton" style="height:160px"></div></div>
              </div>

              <!-- Cargar más -->
              <div class="text-center mt-3">
                <button id="load-more-promos" class="btn btn-outline-primary" data-cursor="" aria-label="Cargar más promociones">Cargar más</button>
              </div>
            </div>
          </div>
        </section>

        <!-- HISTORIAL -->
        <section id="historial" aria-labelledby="historial-heading" class="mb-5">
          <div class="card">
            <div class="card-header"><strong>Historial reciente</strong></div>
            <div class="card-body">
              <ul id="historial-list" class="list-group list-group-flush">
                <li class="list-group-item d-flex justify-content-between align-items-start">
                  <div>
                    <div class="fw-bold">Local 2 - 2x1</div>
                    <div class="small-muted">Usado: 05/10/2025</div>
                  </div>
                  <div class="small-muted">Estado: Aceptado</div>
                </li>
                <!-- más items renderizados por backend/JS -->
              </ul>
            </div>
          </div>
        </section>

      </main>
    </div>
  </div>

  <!-- MODAL: DETALLE PROMOCIÓN -->
  <div class="modal fade" id="promoModal" tabindex="-1" aria-labelledby="promoModalTitle" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title" id="promoModalTitle">Detalle promoción</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body" id="promoModalBody">
          <div class="skeleton" style="height:220px"></div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-outline-secondary" data-bs-dismiss="modal">Cerrar</button>
          <button id="modalSolicitarBtn" class="btn btn-primary">Solicitar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- SCRIPTS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    /*************************************************************************
     * JS de comportamiento:
     * - intenta fetch a /api/promociones_publicas.php
     * - si falla usa sampleData
     * - renderiza grid, boton cargar más (cursor), modal detalle
     *
     * Reemplazar endpoints en production.
     *************************************************************************/

    // ---------- Datos de ejemplo (fallback) ----------
    const sampleData = {
      results: [
        { id: 301, titulo: "20% en prendas - Local XYZ", local: "Local XYZ", rubro: "Indumentaria", categoria_minima: "Inicial", desde: "2025-10-01", hasta: "2025-10-31", dias: "Lun,Mar,Mié", descripcion: "20% en pago contado. No acumulable.", imagen_url: "https://via.placeholder.com/300x200?text=Local+XYZ" },
        { id: 298, titulo: "2x1 heladería - Local Helado", local: "Heladería Feliz", rubro: "Alimentos", categoria_minima: null, desde: "2025-09-20", hasta: "2025-11-10", dias: "Todos", descripcion: "2x1 en cucuruchos.", imagen_url: "https://via.placeholder.com/300x200?text=Helader%C3%ADa" },
        { id: 289, titulo: "Descuento 15% - Farmacia Salud", local: "Farmacia Salud", rubro: "Salud", categoria_minima: "Medium", desde: "2025-10-10", hasta: "2025-10-20", dias: "Lun-Vie", descripcion: "15% en analgesicos seleccionados.", imagen_url: "https://via.placeholder.com/300x200?text=Farmacia" }
      ],
      nextCursor: 289,
      count: 3
    };

    // ---------- Selectores ----------
    const promosGrid = document.getElementById('promos-grid');
    const promosCount = document.getElementById('promos-count');
    const countAvailable = document.getElementById('count-available');
    const countUsed = document.getElementById('count-used');
    const countNews = document.getElementById('count-news');
    const loadMoreBtn = document.getElementById('load-more-promos');

    // estado
    let cursor = '';
    let loading = false;

    // fetch promos (cursor-based)
    async function fetchPromos({ q = '', rubro = '', cursorParam = '' } = {}) {
      // Endpoint recomendada: /api/promociones_publicas.php?q=...&rubro=...&cursor=...
      const url = `/api/promociones_publicas.php?q=${encodeURIComponent(q)}&rubro=${encodeURIComponent(rubro)}&cursor=${encodeURIComponent(cursorParam)}`;
      try {
        const res = await fetch(url, { cache: 'no-cache' });
        if (!res.ok) throw new Error('fetch_error');
        const data = await res.json();
        return data;
      } catch (err) {
        // fallback a sampleData (para demo local)
        console.warn('Fetch promos falló, usando datos de ejemplo.', err);
        // Simular paginación simple con sampleData:
        return Promise.resolve(sampleData);
      }
    }

    // render promos
    function renderPromos(data, append = false) {
      if (!append) promosGrid.innerHTML = '';
      const rows = data.results || [];
      if (!append && rows.length === 0) {
        promosGrid.innerHTML = `<div class="col-12"><div class="p-4 text-center small-muted">No se encontraron promociones.</div></div>`;
      } else {
        rows.forEach(p => {
          const col = document.createElement('div');
          col.className = 'col';
          col.innerHTML = `
            <article class="promo-card" role="article" aria-label="Promoción ${escapeHtml(p.titulo)}">
              <div class="d-flex gap-3">
                <img src="${escapeHtml(p.imagen_url || 'https://via.placeholder.com/96')}" alt="${escapeHtml(p.local)} - ${escapeHtml(p.titulo)}" class="promo-img" loading="lazy">
                <div class="flex-grow-1 d-flex flex-column">
                  <div class="d-flex justify-content-between align-items-start">
                    <div>
                      <h3 class="h6 mb-1">${escapeHtml(p.titulo)}</h3>
                      <div class="small-muted">${escapeHtml(p.local)} · Rubro: ${escapeHtml(p.rubro || '—')}</div>
                    </div>
                    <div>
                      <span class="promo-badge">${p.categoria_minima || 'Todos'}</span>
                    </div>
                  </div>
                  <p class="small-muted mb-1 mt-2">Vigencia: <strong>${escapeHtml(p.desde)} → ${escapeHtml(p.hasta)}</strong></p>
                  <p class="mb-2" style="flex:1">${escapeHtml(p.descripcion || '')}</p>

                  <div class="d-flex justify-content-between align-items-center mt-2">
                    <div class="small-muted">Válido: ${escapeHtml(p.dias || '—')}</div>
                    <div class="d-flex gap-2">
                      <button class="btn btn-sm btn-outline-primary btn-details" data-id="${p.id}" aria-label="Ver detalles ${escapeHtml(p.titulo)}">Detalles</button>
                      <button class="btn btn-sm btn-primary btn-guardar" data-id="${p.id}" aria-label="Guardar promoción ${escapeHtml(p.titulo)}">Guardar</button>
                    </div>
                  </div>
                </div>
              </div>
            </article>
          `;
          promosGrid.appendChild(col);
        });
      }

      // actualizar contadores y cursor
      promosCount.textContent = `${data.count || (data.results && data.results.length) || 0} promociones mostradas`;
      countAvailable.textContent = data.count || (data.results && data.results.length) || 0;
      // valores demo para otros contadores (reemplazar por consultas reales)
      countUsed.textContent = '3';
      countNews.textContent = '2';

      // actualizar cursor
      cursor = data.nextCursor || '';
      loadMoreBtn.dataset.cursor = cursor;
      if (!cursor) loadMoreBtn.style.display = 'none';
      else loadMoreBtn.style.display = 'inline-block';

      // attach handlers
      attachCardHandlers();
    }

    // attach button handlers
    function attachCardHandlers() {
      document.querySelectorAll('.btn-details').forEach(btn => {
        btn.onclick = async (e) => {
          const id = e.currentTarget.dataset.id;
          // cargar detalle (endpoint: /api/promo_detalle.php?id=)
          try {
            const res = await fetch(`/api/promo_detalle.php?id=${encodeURIComponent(id)}`);
            if (!res.ok) throw new Error('err');
            const data = await res.json();
            showModalDetalle(data);
          } catch (err) {
            // fallback: buscar en sampleData
            const found = sampleData.results.find(x => String(x.id) === String(id));
            showModalDetalle(found || { titulo: 'Detalle no disponible', descripcion: 'No se pudo cargar el detalle.' });
          }
          const modalEl = document.getElementById('promoModal');
          const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
          modal.show();
        };
      });

      document.querySelectorAll('.btn-guardar').forEach(btn => {
        btn.onclick = (e) => {
          const id = e.currentTarget.dataset.id;
          // Lógica para guardar: llamar endpoint /api/guardar_promo.php (POST)
          // Aquí mostramos toast simple (alert)
          alert('Promoción guardada (demo). ID: ' + id);
        };
      });
    }

    // mostrar detalle dentro del modal
    function showModalDetalle(data) {
      const body = document.getElementById('promoModalBody');
      const title = document.getElementById('promoModalTitle');
      title.textContent = data.titulo || 'Detalle promoción';
      body.innerHTML = `
        <div class="row g-3">
          <div class="col-12 col-md-5">
            <img src="${escapeHtml(data.imagen_url || 'https://via.placeholder.com/400x300')}" alt="${escapeHtml(data.local || '')}" class="img-fluid rounded">
          </div>
          <div class="col-12 col-md-7">
            <p><strong>Local:</strong> ${escapeHtml(data.local || '—')}</p>
            <p><strong>Vigencia:</strong> ${escapeHtml(data.desde || '—')} → ${escapeHtml(data.hasta || '—')}</p>
            <p><strong>Válido:</strong> ${escapeHtml(data.dias || '—')}</p>
            <p>${escapeHtml(data.descripcion || '—')}</p>
            <p class="small-muted">Categoría mínima: <strong>${data.categoria_minima || 'Todos'}</strong></p>
          </div>
        </div>
      `;
      // opcional: activar botón solicitar para llamar endpoint cuando el usuario esté logueado
      const solicitarBtn = document.getElementById('modalSolicitarBtn');
      solicitarBtn.onclick = () => {
        alert('Solicitar promo: demo (implementá endpoint /api/solicitar_promocion.php).');
      };
    }

    // escape para seguridad básica al inyectar HTML
    function escapeHtml(text) {
      if (text === null || text === undefined) return '';
      return String(text)
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'",'&#039;');
    }

    // inicializar: cargar primeras promos
    (async function init() {
      // intentar cargar rubros dinámicos (si existe endpoint)
      try {
        const res = await fetch('/api/rubros.php');
        if (res.ok) {
          const rubros = await res.json();
          const select = document.getElementById('promos-filter-rubro');
          rubros.forEach(r => {
            const opt = document.createElement('option');
            opt.value = r.id;
            opt.textContent = r.nombre;
            select.appendChild(opt);
          });
        }
      } catch(e){ /* silencio: fallback */ }

      const data = await fetchPromos({});
      renderPromos(data);

      // set listeners
      document.getElementById('promos-clear').onclick = async () => {
        document.getElementById('promos-search').value = '';
        document.getElementById('promos-filter-rubro').value = '';
        const d = await fetchPromos({});
        renderPromos(d);
      };

      // búsqueda con debounce
      let debounceTimer = null;
      document.getElementById('promos-search').addEventListener('input', (e) => {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(async () => {
          const q = e.target.value.trim();
          const rubro = document.getElementById('promos-filter-rubro').value;
          const d = await fetchPromos({ q, rubro });
          renderPromos(d);
        }, 300);
      });

      // load more
      loadMoreBtn.onclick = async () => {
        if (!cursor) return;
        loadMoreBtn.disabled = true;
        loadMoreBtn.textContent = 'Cargando...';
        const q = document.getElementById('promos-search').value.trim();
        const rubro = document.getElementById('promos-filter-rubro').value;
        const d = await fetchPromos({ q, rubro, cursorParam: cursor });
        renderPromos(d, true); // append
        loadMoreBtn.disabled = false;
        loadMoreBtn.textContent = 'Cargar más';
      };
    })();

  </script>
</body>
</html>
